<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stay Home ãƒªãƒ™ãƒ³ã‚¸</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        canvas { box-shadow: 0 0 20px rgba(0,255,0,0.2); }
    </style>
</head>
<body>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
let score = 0;
let laserGauge = 0;
let hearts = [];
let maxHearts = 3;
let currentLife = 3; // ç¾åœ¨ã®å‘½ã‚’æ•°ãˆã‚‹å¤‰æ•°ã‚’è¿½åŠ 

// --- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ã‚·ãƒ¼ãƒ³ ---
class TitleScene extends Phaser.Scene {
    constructor() { super({ key: 'TitleScene' }); }

    preload() {
        this.load.image('title_bg', 'title.png');
        // BGMãŒã‚ã‚Œã°ã“ã“ã§èª­ã¿è¾¼ã¿
     this.load.audio('bgm', 'OH!COVID-19.mp3');
        this.load.audio('failed_sound', 'Failed.mp3'); // è¿½åŠ ï¼
    }

create() {
        this.add.image(200, 300, 'title_bg').setDisplaySize(400, 600);

        let bgm = this.sound.get('bgm');
        if (!bgm) {
            // æœ¬å½“ã«åˆã‚ã¦ã®æ™‚ã ã‘æ–°ã—ãä½œã‚‹
            this.sound.play('bgm', { loop: true, volume: 0.25 });
        } else if (!bgm.isPlaying) {
            // æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦æ­¢ã¾ã£ã¦ã„ã‚‹æ™‚ã ã‘å†ç”Ÿã™ã‚‹
            bgm.play();
        }
        // ----------------------
        
        // ...ï¼ˆä»¥ä¸‹ã€PUSH STARTã®ãƒ†ã‚­ã‚¹ãƒˆãªã©ï¼‰
        let startText = this.add.text(200, 500, 'PUSH START', {
            fontSize: '32px', fill: '#fff', stroke: '#000', strokeThickness: 6
        }).setOrigin(0.5);

        this.tweens.add({
            targets: startText, alpha: 0, duration: 800, yoyo: true, loop: -1
        });

        this.input.once('pointerdown', () => {
            this.cameras.main.fadeOut(500, 0, 0, 0);
            this.cameras.main.once('camerafadeoutcomplete', () => {
                this.scene.start('GameScene');
            });
        });
    }
}

// --- ã‚²ãƒ¼ãƒ æœ¬ç·¨ã®ã‚·ãƒ¼ãƒ³ ---
class GameScene extends Phaser.Scene {
    constructor() { super({ key: 'GameScene' }); }

    preload() {
        this.load.image('player', 'player.png');
        this.load.image('covid', 'covid.png');
        this.load.image('missile', 'amabie.png');
        this.load.image('mask', 'mask2.png');
        this.load.image('city', 'background.png');
    }

//preload() {
//        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ä»£ã‚ã‚Šã«ã€ãƒãƒƒãƒˆä¸Šã®ãƒ†ã‚¹ãƒˆç”¨ç”»åƒã‚’ä½¿ã†è¨­å®šï¼ˆå‹•ä½œç¢ºèªç”¨ï¼‰
  //      this.load.image('player', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
    //    this.load.image('covid', 'https://labs.phaser.io/assets/sprites/apple.png');
      //  this.load.image('mask', 'https://labs.phaser.io/assets/sprites/shinyball.png');
 //       this.load.image('city', 'https://labs.phaser.io/assets/skies/space3.png');
   // }

    create() {
        // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
score = 0;
        // GameScene ã® create() å†…ã€score = 0; ã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ 
let bgm = this.sound.get('bgm');
if (bgm && !bgm.isPlaying) {
    bgm.play();
}
        laserGauge = 0;
        currentLife = maxHearts; // ã“ã“ã§3ã«ãƒªã‚»ãƒƒãƒˆï¼
        
        this.refreshHearts(); // ãƒãƒ¼ãƒˆã‚’æç”»
        // èƒŒæ™¯ï¼ˆç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
        this.cityBG = this.add.tileSprite(200, 300, 400, 600, 'city');

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­å®šï¼ˆç”Ÿæˆãƒ»ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ»é‡ã­é †ã‚’ä¸€è¡Œã§ï¼ï¼‰
this.player = this.physics.add.sprite(200, 500, 'player').setScale(0.15).setDepth(1);

// ç”»é¢ã®å¤–ã«å‡ºãªã„ã‚ˆã†ã«ã™ã‚‹è¨­å®š
this.player.setCollideWorldBounds(true);

        // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
        this.covids = this.physics.add.group();
        this.missiles = this.physics.add.group();
        this.items = this.physics.add.group();

        // UI: ã‚¹ã‚³ã‚¢ã¨ã‚²ãƒ¼ã‚¸
        this.scoreLabel = this.add.text(20, 70, 'Score: 0', { fontSize: '24px', fill: '#fff', stroke: '#000', strokeThickness: 3 });
        this.gaugeLabel = this.add.text(20, 100, 'Special: 0%', { fontSize: '18px', fill: '#ff0', stroke: '#000', strokeThickness: 3 });

        // æ®‹æ©Ÿè¡¨ç¤ºï¼ˆåˆæœŸ2ã¤ï¼‰
        this.refreshHearts();

        // æ•µç”Ÿæˆã‚¿ã‚¤ãƒãƒ¼
        this.time.addEvent({ delay: 200, callback: this.addCovid, callbackScope: this, loop: true });
        
        // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆã‚¿ã‚¤ãƒãƒ¼ï¼ˆ15ç§’ã«1å›ï¼‰
        this.time.addEvent({ delay: 15000, callback: this.spawnItem, callbackScope: this, loop: true });

        // å½“ãŸã‚Šåˆ¤å®š
        this.physics.add.overlap(this.player, this.covids, this.hitEnemy, null, this);
        this.physics.add.overlap(this.player, this.items, this.getItem, null, this);
        this.physics.add.overlap(this.missiles, this.covids, this.destroyEnemy, null, this);

        // ã‚¯ãƒªãƒƒã‚¯ã§æ”»æ’ƒ
        this.input.on('pointerdown', () => {
            if (laserGauge >= 100) this.useSpecial();
            else this.fireMissile();
        });
    }

    update() {
        // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        this.cityBG.tilePositionY -= 2;

        // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦èƒŒæ™¯è‰²å¤‰åŒ–ï¼ˆå¤•æš®ã‚Œã€œå¤œï¼‰
        if (score > 10000) this.cityBG.setTint(0xffaa66);
        if (score > 20000) this.cityBG.setTint(0x6666ff);

        // ç§»å‹•ï¼ˆãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒè¿½å¾“ï¼‰
        this.player.x = Phaser.Math.Linear(this.player.x, this.input.activePointer.x, 0.2);

        // ã‚¹ã‚³ã‚¢åŠ ç®—
        score += 1;
        this.scoreLabel.setText('Score: ' + Math.floor(score / 10));

        // ã‚²ãƒ¼ã‚¸åŠ ç®—
        if (laserGauge < 100) {
            laserGauge += 0.1;
            this.gaugeLabel.setText(`Special: ${Math.floor(laserGauge)}%`);
        }
    }


addCovid() {
        let x = Phaser.Math.Between(50, 350);
        let covid = this.covids.create(x, -50, 'covid');

        // 0.03ï¼ˆæ¥µå°ï¼‰ã‹ã‚‰ 0.15ï¼ˆå·¨å¤§ï¼‰ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
        let randomScale = Phaser.Math.FloatBetween(0.01, 0.1);
        covid.setScale(randomScale);

        // é‡ã­é †ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šå¾Œã‚(0)ã«ã™ã‚‹ãªã‚‰è¨­å®šä¸è¦ã§ã™ãŒã€
        // å¿µã®ãŸã‚è¨­å®šã™ã‚‹ãªã‚‰
        covid.setDepth(0.5);

        covid.setVelocityY(200);
    }
    
    spawnItem() {
        let x = Phaser.Math.Between(50, 350);
        let item = this.items.create(x, -50, 'mask').setScale(0.3).setTint(0x00ff00);
        item.setVelocityY(150);
    }

    fireMissile() {
        let m = this.missiles.create(this.player.x, this.player.y - 40, 'missile');
        m.setScale(0.02).setVelocityY(-600);
    }

    useSpecial() {
        laserGauge = 0;
        this.cameras.main.flash(500, 255, 255, 255);
        this.covids.getChildren().forEach(c => {
            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä»£ã‚ã‚Šã®ç‚¹æ»…
            this.tweens.add({ targets: c, alpha: 0, duration: 200, onComplete: () => c.destroy() });
        });
        this.covids.clear(true, true);
    }

    destroyEnemy(missile, covid) {
        missile.destroy();
        covid.destroy();
        score += 500;
    }

hitEnemy(player, covid) {
        covid.destroy();
        
        currentLife--; // å‘½ã‚’1æ¸›ã‚‰ã™
        this.refreshHearts(); // è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒãƒ¼ãƒˆãŒ1ã¤æ¶ˆãˆã‚‹ï¼‰
        this.cameras.main.shake(200, 0.02); // ç”»é¢ã‚’æºã‚‰ã™

        if (currentLife <= 0) {
            this.gameOver();
        }
    }
getItem(player, item) {
        item.destroy();
        
        // ã€Œå®Ÿéš›ã®å‘½ã®æ•°ã€ãŒæœ€å¤§å€¤ï¼ˆ3ï¼‰ã‚ˆã‚Šå°ã•ã„ã‹ãƒã‚§ãƒƒã‚¯
        if (currentLife < maxHearts) {
            currentLife++;        // 1. å®Ÿéš›ã®æ•°å­—ã‚’å¢—ã‚„ã™
            this.refreshHearts(); // 2. å¢—ãˆãŸæ•°å­—ã‚’ã‚‚ã¨ã«ãƒãƒ¼ãƒˆã‚’æãç›´ã™
        }
    }
refreshHearts() {
        // ä»Šå‡ºã¦ã„ã‚‹ç”»åƒã‚’å…¨éƒ¨æ¶ˆã™
        hearts.forEach(h => h.destroy());
        hearts = [];

        // currentLifeï¼ˆ3, 2, 1...ï¼‰ã®æ•°ã ã‘ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹
        for (let i = 0; i < currentLife; i++) {
            let h = this.add.image(40 + (i * 45), 40, 'mask').setScale(0.3);
            hearts.push(h);
        }
    }
    gameOver() {
        this.physics.pause();
        this.player.setTint(0xff0000);
        // --- BGMã‚’æ­¢ã‚ã¦å¤±æ•—éŸ³ã‚’é³´ã‚‰ã™ ---
        this.sound.stopAll(); // ã™ã¹ã¦ã®éŸ³ã‚’åœæ­¢
        this.sound.play('failed_sound', { volume: 0.3 }); // å¤±æ•—éŸ³ã‚’å†ç”Ÿ
        // ------------------------------
        let finalScore = Math.floor(score / 10);
        let msg = `ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ã¯ ${finalScore} ã§ã™ï¼\nãŠã¨ãªã—ãå®¶ã«ã„ã¾ã—ã‚‡ã†ã­ï¼`;
        
        this.add.text(200, 250, 'Stay Home...', { fontSize: '40px', fill: '#f00', stroke: '#000', strokeThickness: 5 }).setOrigin(0.5);
        this.add.text(200, 350, msg, { fontSize: '18px', fill: '#fff', align: 'center' }).setOrigin(0.5);

        let shareBtn = this.add.text(200, 450, 'ğŸ¦ Twitterã§ã‚·ã‚§ã‚¢', { fontSize: '24px', fill: '#1DA1F2', backgroundColor: '#fff', padding: 10 }).setOrigin(0.5).setInteractive();
        shareBtn.on('pointerdown', () => {
            let url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(msg + " #StayHome")}`;
            window.open(url, '_blank');
        });

        let retryBtn = this.add.text(200, 520, 'ã‚‚ã†ä¸€åº¦éŠã¶', { fontSize: '20px', fill: '#fff' }).setOrigin(0.5).setInteractive();
        retryBtn.on('pointerdown', () => this.scene.restart());
    }
}

// --- ã‚²ãƒ¼ãƒ èµ·å‹• ---
const config = {
    type: Phaser.AUTO,
    width: 400,
    height: 600,
    physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
    scene: [TitleScene, GameScene]
};
const game = new Phaser.Game(config);
</script>
</body>

</html>








